#include <iostream>
#include <cmath>
#include <sys/time.h>
#include "include/light_tracking.h"

#include <wiringPi.h>
#include <wiringSerial.h>

using namespace std;
using namespace cv;

inline float calc_Angle(float xl, float xr);
inline float calc_Distance(float xl, float xr);
void find_Reference_Val_in_Table(float xl, float xr, float *angle, float *distance);

int main(void) {

    const bool is_show_image = true;
    const bool is_show_data  = true;

    const int img_width_half = 320;

    VideoCapture cap(0);
    Mat img_stereo_raw;
    Mat imgl, imgr;
    if (!cap.isOpened())
        return -1;

    unsigned char iLowR = 220, iHighR = 255;        // 180, 255 200,155
    unsigned char iLowG = 5,   iHighG = 255;       // 50, 255   0,255   5, 255
    unsigned char iLowB = 0,   iHighB = 255;       // 50, 255  0,255    0, 255
    __light_tracking _t(iLowR, iHighR,
                        iLowG, iHighG,
                        iLowB, iHighB);

    vector<Point2f> temp;
    Point2f center_l = { 0. }, center_r = { 0. };
    float dist = 0, angle = 0;
    float dist_last = 250, angle_last = 0;

    int fd;
    char text_2_send[30] = { 0 };
    if((fd = serialOpen ("/dev/ttyS0", 9600)) < 0) {
        printf("serial err\n");
        return -1;
    }

    struct timeval t = { 0 }, t_last = { 0 };
    double dt;

    while (true) {

        cap >> img_stereo_raw;
        //resize(img_stereo_raw, img_stereo_raw, Size(960, 360), 0, 0, INTER_NEAREST);  // 960, 360


	Mat imageRGB[3];
	split(img_stereo_raw, imageRGB);
	for (int i = 0; i < 3; i++)
	{
		equalizeHist(imageRGB[i], imageRGB[i]);
	}
	merge(imageRGB, 3, img_stereo_raw);

        _t.update(img_stereo_raw, is_show_image);
        temp = _t.get_CenterPts();

        cout<<"size:"<<temp<<endl;
        if (temp.size() == 0) {
            dist = 0;
            angle = 0;
            //sprintf(text_2_send, "S%f %fE", 0., 0.);
            //serialPuts(fd, text_2_send);
            //continue;
        }
        else if (temp.size() == 1) {
            float p1, p2;
            if(temp[0].x > img_width_half) {    // Left, for left and right are inversed
                p1 = 0.2932;
                p2 =  -101.1;
                temp[0].x -= img_width_half;
            }
            else {
                p1 = 0.2894;
                p2 = -36.98;
            }
                dist  = 250;
                angle = p1 * temp[0].x + p2;

        }
        else {
            if (temp[0].x > temp[1].x) {
                center_l = temp[0];
                center_r = temp[1];
            }
            else {
                center_l = temp[1];
                center_r = temp[0];
            }

            center_l.x = center_l.x - 320;
            cout<<"center_l.x:"<<center_l.x + img_width_half <<"center_r.x:"<<center_r.x<<endl;
            cout<<"center_l.y:"<<center_l.y<<"center_r.y:"<<center_r.y<<endl;

            dist  = calc_Distance(center_l.x, center_r.x);
            angle = calc_Angle(center_l.x, center_r.x);

            //cout << "dist: " << dist << " angle: " << angle << endl;
        }
/*
        if (fabs(dist  - dist_last)  < 50 && (dist > 0 && dist < 500))
            dist_last = dist;
        else if (dist < 0 || dist > 500)
            dist = dist_last;
        if (fabs(angle - angle_last) < 10  && fabs(angle) < 45.0)
            angle_last = angle;
        else if (fabs(angle) > 45.0f)
            angle = angle_last;
*/

        if (dist < 0 || dist > 500 || fabs(angle) > 45.0f)
            find_Reference_Val_in_Table(center_l.x, center_r.x, &angle, &dist);

        sprintf(text_2_send, "S%.2f %.2fE", dist, angle);
        serialPuts(fd, text_2_send);

        t_last = t;
        gettimeofday(&t, NULL);
        dt = (t.tv_usec - t_last.tv_usec) / 1e3;
        if (dt < 0)
            dt += 1e6;

        if (is_show_image) {
            imshow("stereo_raw_l", img_stereo_raw);
            waitKey(5);
        }

        if (is_show_data) {
            cout << "dist: " << dist << " angle: " << angle << endl;
            cout << "dt: " << dt << endl;
        }
    }

    serialClose(fd);
    return 0;
}

inline float calc_Angle(float xl, float xr) {
/*
    float p00 = -183.3;
    float p10 = 1.015;
    float p01 = -0.8573;
    float p20 = -0.001553;
    float p11 = 0.003623;
    float p02 = -0.001979;

    float x = xl;
    float y = xr;

    return p00 + p10 * x + p01 * y + p20 * x*x + p11 * x*y + p02 * y*y;
*/
    float x = xl;
    float y = xr;

    float p00 =       -47.2;
    float p10 =      0.1984;
    float p01 =        0.11;

    return  p00 + p10*x + p01*y;
}

inline float calc_Distance(float xl, float xr) {

    float p1 = 2.337;
    float p2 = 1305;
    float q1 = -9.252;

    float x = xl - xr;
    float rst;

    rst = (p1*x + p2) / (x + q1);

    if (rst < 80) {
        p1 = 1269;
        q1 = -6.994;

        rst = p1 / (x + q1);
//      cout<<"######"<<endl;
    }
//  cout<<"&&&"<<endl;
    return rst;
}

float ref_table[220][7] = {
    0,	30,	0,	182,	115,	135,	108,
    0.165136513,	30.41381265,	9.462322208,	212,	122,	163,	116,
    0.321726856,	31.6227766,	18.43494882,	248,	130,	198,	123,
    0,	28,	0,	184,	118,	133,	111,
    0.310975374,	29.41088234,	17.81888891,	240,	128,	189,	122,
    0.434638199,	30.87069808,	24.90476881,	265,	133,	215,	126,
    0,	26,	0,	183,	120,	129,	114,
    0.152638085,	26.30589288,	8.746162263,	210,	124,	156,	118,
    0.298476945,	27.20294102,	17.10272897,	238,	130,	185,	124,
    0.400211177,	28.23118843,	22.93210044,	261,	134,	207,	127,
    0.295419076,	24.04163056,	16.92751306,	245,	137,	187,	131,
    0.439810186,	18.78829423,	25.20112365,	276,	161,	209,	158,
    0.587959294,	18.02775638,	33.69006753,	287,	171,	234,	176,
    0.587959294,	14.4222051,	33.69006753,	285,	185,	221,	189,
    0.785340314,	12.72792206,	45,	294,	202,	223,	199,
    0.558558171,	9.433981132,	32.00538321,	272,	198,	188,	197,
    0.260583197,	7.762087348,	14.93141718,	241,	194,	120,	192,
    -0.528035553,	13.89244399,	-30.25643716,	95,	165,	27,	151,
    -0.674691244,	12.80624847,	-38.65980825,	94,	179,	19,	168,
    -0.785340314,	11.3137085,	-45,	96,	185,	14,	187,
    -0.493904987,	14.76482306,	-28.30075577,	100,	159,	32,	146,
    -0.484442244,	21.47091055,	-27.7585406,	83,	122,	27,	155,
    -0.295419076,	24.04163056,	-16.92751306,	103,	117,	43,	111,
    -0.214044917,	23.53720459,	-12.26477373,	134,	120,	74,	114,
    -0.158643576,	25.3179778,	-9.090276921,	147,	118,	91,	111,
    -0.272988594,	25.96150997,	-15.64224646,	119,	114,	63,	107,
    -0.447487013,	27.73084925,	-25.64100582,	83,	126,	34,	124,
    -0.336650021,	21.1896201,	-19.29004622,	114,	144,	51,	144,
    -0.19738102,	25.49509757,	-11.30993247,	129,	131,	75,	128,
    -0.321726856,	25.29822128,	-18.43494882,	105,	132,	50,	130,
    -0.394762041,	26,	-22.61986495,	93,	129,	39,	128,
    -0.295419076,	24.04163056,	-16.92751306,	115,	136,	57,	135,
    -0.179840253,	22.36067977,	-10.30484647,	133,	141,	74,	139,
    0.266232438,	22.8035085,	15.2551187,	217,	156,	159,	150,
    0.309680133,	26.2488095,	17.74467163,	225,	151,	172,	144,
    0.204002952,	29.61418579,	11.68936918,	202,	137,	154,	131,
    0.278279161,	29.12043956,	15.9453959,	219,	143,	171,	136,
    0.321726856,	31.6227766,	18.43494882,	230,	143,	184,	136,
    0.489921238,	34,	28.07248694,	260,	151,	213,	141,
    0.291435327,	31.32091953,	16.69924423,	217,	144,	172,	136,
    0.185334298,	32.55764119,	10.61965528,	197,	139,	152,	132,
    0.244960619,	32.984845,	14.03624347,	214,	141,	171,	132,
    0.587959294,	36.05551275,	33.69006753,	279,	155,	233,	147,
    0.726588819,	24.08318916,	41.63353934,	291,	177,	254,	175,
    0.463613459,	22.36067977,	26.56505118,	257,	167,	196,	161,
    0.442341639,	21.02379604,	25.34617594,	256,	175,	190,	170,
    0.463613459,	17.88854382,	26.56505118,	261,	186,	189,	185,
    0.372960249,	24.69817807,	21.37062227,	234,	157,	178,	148,
    0.255163595,	23.76972865,	14.62087399,	217,	152,	158,	145,
    0.244960619,	24.73863375,	14.03624347,	204,	145,	155,	142,
    0.309680133,	26.2488095,	17.74467163,	218,	148,	166,	140,
    0.380478351,	26.92582404,	21.80140949,	235,	152,	181,	142,
    0.19738102,	30.59411708,	11.30993247,	212,	141,	163,	134,
    0.30089807,	30.3644529,	17.2414594,	231,	146,	183,	138,
    0.404861964,	30.46309242,	23.19859051,	234,	136,	190,	126,
    0.185334298,	32.55764119,	10.61965528,	206,	137,	162,	130,
    0.203030262,	34.71310992,	11.633634,	202,	135,	166,	127,
    0.286030372,	35.44009029,	16.38954033,	222,	137,	180,	129,
    0.278279161,	36.40054945,	15.9453959,	219,	135,	179,	128,
    0.337853301,	39.2173431,	19.35899418,	232,	135,	192,	127,
    -0.19738102,	35.6931366,	-11.30993247,	135,	116,	93,	109,
    -0.291435327,	31.32091953,	-16.69924423,	118,	120,	72,	113,
    -0.215341837,	32.75667871,	-12.33908728,	132,	119,	87,	112,
    -0.348745315,	35.11409973,	-19.98310652,	103,	113,	61,	105,
    -0.274147257,	33.24154028,	-15.70863783,	116,	117,	72,	109,
    -0.191170378,	31.57530681,	-10.95406264,	134,	121,	88,	114,
    -0.235527631,	25.70992026,	-13.49573328,	133,	132,	77,	124,
    -0.380478351,	26.92582404,	-21.80140949,	99,	127,	46,	120,
    0,	60,	0,	162,	105,	134,	99,
    0.128901277,	54.45181356,	7.386043151,	190,	113,	160,	104,
    0.249960209,	48.50773134,	14.32271998,	206,	118,	173,	111,
    0.293567363,	44.92215489,	16.82140989,	220,	123,	184,	116,
    0.435321209,	47.42362281,	24.94390526,	248,	128,	214,	121,
    0.296523967,	37.64306045,	16.99082329,	224,	135,	183,	126,
    -0.224694617,	35.90264614,	-12.87500156,	129,	115,	88,	109,
    -0.321726856,	37.94733192,	-18.43494882,	119,	110,	79,	104,
    -0.305856342,	39.84971769,	-17.52556837,	113,	107,	74,	101,
    -0.202306726,	39.81205847,	-11.59217541,	131,	110,	93,	103,
    -0.172178132,	46.69047012,	-9.865806943,	132,	104,	99,	98,
    -0.206308697,	43.93176527,	-11.82148834,	127,	104,	92,	98,
    -0.256132515,	43.41658669,	-14.67639314,	120,	105,	83,	97,
    -0.139085696,	50.48762225,	-7.969610394,	138,	103,	106,	96,
    -0.152638085,	52.61178575,	-8.746162263,	137,	101,	106,	94,
    -0.226782143,	53.36665626,	-12.99461679,	123,	98,	92,	92,
    0.235527631,	51.41984053,	13.49573328,	207,	120,	174,	112,
    0.181306419,	61,	10.38885782,	198,	113,	168,	106,
    0.116133072,	60.40695324,	6.654425046,	189,	111,	160,	104,
    0.1278605,	70.57619995,	7.32640666,	187,	107,	160,	100,
    0.085498996,	70.25667228,	4.899092454,	177,	106,	152,	99,
    0.12265962,	73.55270219,	7.028396239,	181,	104,	159,	99,
    0.08089814,	74.24284477,	4.635463427,	175,	104,	151,	97,
    0.076766237,	78.23042886,	4.398705355,	176,	103,	152,	96,
    0.099661311,	80.39900497,	5.710593137,	181,	103,	157,	96,
    -0.099661311,	70.34912935,	-5.710593137,	146,	100,	121,	92,
    -0.122452037,	65.49045732,	-7.016501745,	140,	101,	113,	94,
    -0.151364294,	59.68249325,	-8.673174048,	135,	102,	106,	95,
    -0.148149108,	67.74215822,	-8.488943881,	144,	92,	457,	99,
    -0.109145423,	73.43704787,	-6.254032744,	142,	98,	117,	92,
    0.173232906,	81.21576202,	9.926245507,	194,	79,	170,	73,
    0.121343062,	82.60750571,	6.952957468,	185,	77,	161,	71,
    0.250182119,	92.89241088,	14.33543542,	207,	80,	184,	74,
    0.140239279,	85.84287973,	8.035710711,	188,	77,	164,	71,
    0.204002952,	88.84255737,	11.68936918,	199,	79,	176,	73,
    -0.121343062,	82.60750571,	-6.952957468,	143,	70,	110,	64,
    -0.141886603,	84.85281374,	-8.130102354,	136,	69,	112,	63,
    0,	84,	0,	160,	72,	137,	66,
    -0.125760157,	87.69264507,	-7.206057001,	139,	69,	116,	63,
    -0.143441697,	90.93404203,	-8.219209249,	134,	68,	111,	61,
    -0.107107434,	93.53608929,	-6.137255949,	141,	69,	119,	63,
    -0.08489554,	94.33981132,	-4.864514438,	145,	69,	123,	63,
    0.085803944,	93.34345183,	4.916566006,	176,	74,	154,	68,
    0.110649071,	90.55385138,	6.340191746,	181,	75,	158,	69,
    0,	90,	0,	162,	72,	139,	65,
    0.126963437,	94.76286192,	7.275004958,	184,	76,	162,	69,
    0.153412621,	98.15294188,	8.790543183,	189,	76,	167,	70,
    0.081446045,	98.32598843,	4.666858371,	176,	74,	155,	67,
    0.099661311,	100.4987562,	5.710593137,	179,	74,	158,	68,
    -0.105976552,	94.53041838,	-6.072456407,	142,	69,	120,	63,
    -0.144801832,	97.01546269,	-8.29714497,	136,	67,	113,	61,
    -0.1717475,	99.46356117,	-9.84113176,	129,	66,	108,	60,
    -0.207480943,	97.08243919,	-11.88865804,	121,	65,	100,	59,
    -0.153412621,	98.15294188,	-8.790543183,	133,	67,	112,	61,
    -0.099661311,	100.4987562,	-5.710593137,	143,	68,	122,	62,
    -0.16674153,	102.420701,	-9.554289672,	131,	66,	109,	60,
    -0.146001503,	103.0970417,	-8.365886124,	134,	66,	113,	60,
    -0.169765769,	106.5316854,	-9.727578551,	129,	65,	108,	59,
    -0.111674636,	107.6707946,	-6.398956627,	141,	67,	121,	61,
    -0.136745639,	110.0272693,	-7.835525106,	134,	66,	113,	60,
    0.095852087,	104.4796631,	5.492324557,	179,	74,	158,	67,
    0.12202313,	106.7941946,	6.991925347,	184,	74,	163,	68,
    0,	110,	0,	160,	70,	140,	63,
    0.108653212,	110.6526095,	6.225829064,	180,	74,	160,	67,
    0.126758198,	102.8250942,	7.263244741,	179,	74,	161,	67,
    0.154096766,	104.2353107,	8.829744668,	186,	74,	166,	68,
    0.139269001,	108.0462864,	7.980113745,	184,	74,	165,	67,
    0.064719514,	108.2266141,	3.708428157,	171,	71,	151,	65,
    -0.094054306,	106.4706532,	-5.38931176,	145,	67,	125,	61,
    -0.144603788,	104.0865025,	-8.285797024,	136,	66,	116,	60,
    -0.159011467,	107.3545528,	-9.111357045,	133,	65,	113,	59,
    0,	120,	0,	160,	69,	141,	63,
    0.060267299,	116.211015,	3.453316251,	172,	72,	153,	65,
    0.143072755,	119.2182872,	8.198068846,	187,	74,	167,	68,
    0.173658406,	115.7410904,	9.950626688,	193,	75,	173,	69,
    -0.08673195,	115.4339638,	-4.969740728,	145,	67,	125,	61,
    -0.16649881,	120.6689687,	-9.540381805,	128,	64,	109,	58,
    -0.208761804,	120.6192356,	-11.9620514,	119,	63,	101,	57,
    -0.065475202,	122.2620137,	-3.751729071,	148,	67,	128,	61,
    -0.10444943,	124.6795893,	-5.984952315,	140,	66,	121,	59,
    -0.062904372,	127.251719,	-3.604420539,	148,	67,	129,	61,
    -0.179147303,	129.0658747,	-10.26514046,	126,	63,	107,	57,
    0.079824106,	125.399362,	4.57392126,	175,	72,	156,	65,
    0.129345425,	124.036285,	7.411492859,	184,	73,	165,	67,
    0.18967758,	127.2831489,	10.86852534,	194,	75,	175,	68,
    0.060790078,	115.2128465,	3.483271469,	172,	72,	152,	65,
    0.123328616,	121.9262072,	7.066729716,	181,	73,	164,	67,
    0.161179042,	124.6154084,	9.235559093,	190,	74,	170,	68,
    0,	130,	0,	160,	68,	141,	62,
    0.063908125,	125.2557384,	3.661935576,	171,	70,	152,	64,
    0.144143769,	125.2996409,	8.25943798,	185,	73,	166,	66,
    -0.061456429,	130.2459212,	-3.521453377,	149,	67,	130,	61,
    -0.117556915,	127.8827588,	-6.736011214,	138,	65,	119,	59,
    -0.156186005,	128.5651586,	-8.949458084,	129,	64,	110,	57,
    -0.137576602,	131.2402377,	-7.883139317,	133,	64,	114,	58,
    -0.060527561,	132.242202,	-3.468229259,	149,	67,	130,	61,
    -0.098161048,	132.6386067,	-5.624628041,	142,	66,	123,	59,
    -0.188883267,	138.4629914,	-10.82301123,	123,	62,	105,	56,
    0.059185679,	135.2368293,	3.39133942,	170,	70,	152,	64,
    0.127120832,	134.0820644,	7.284023654,	184,	73,	165,	66,
    0,	140,	0,	159,	68,	140,	61,
    0.069328027,	144.3468046,	3.972495941,	172,	70,	154,	64,
    0.138948532,	144.391828,	7.961750891,	187,	73,	169,	67,
    0.054364132,	147.2175261,	3.11506476,	169,	70,	151,	63,
    0.088800352,	146.5776245,	5.088260198,	175,	71,	157,	64,
    0.115126323,	147.9797283,	6.596738298,	180,	72,	162,	65,
    0,	150,	0,	159,	67,	141,	61,
    0.066563261,	150.3329638,	3.814074834,	171,	70,	154,	63,
    0.052926747,	151.211772,	3.032702616,	169,	69,	151,	63,
    0.131674154,	152.3187447,	7.544929039,	183,	72,	166,	65,
    0.20130228,	150.029997,	11.53462065,	197,	74,	179,	68,
    -0.053278927,	150.2131818,	-3.052882515,	149,	66,	131,	60,
    -0.055881686,	143.2236014,	-3.202020583,	149,	66,	131,	60,
    -0.109936365,	154.9354704,	-6.299353706,	148,	64,	121,	57,
    0,	160,	0,	158,	67,	141,	60,
    -0.049338998,	162.1974106,	-2.827124578,	150,	66,	133,	59,
    -0.13414872,	164.477962,	-7.686721681,	134,	63,	116,	56,
    -0.072594106,	165.4357881,	-4.159642294,	146,	65,	129,	58,
    -0.146001503,	171.8284028,	-8.365886124,	131,	62,	114,	56,
    0,	170,	0,	158,	66,	141,	60,
    0.05909833,	169.2955995,	3.386334329,	170,	69,	153,	62,
    0.096660341,	165.7739425,	5.538637533,	177,	70,	160,	64,
    0.117100119,	171.1724277,	6.709836808,	181,	71,	164,	64,
    0.046206451,	173.1848723,	2.647629665,	167,	68,	150,	62,
    0.150015906,	173.9540169,	8.595911437,	187,	71,	170,	65,
    0.141886603,	176.7766953,	8.130102354,	185,	71,	168,	65,
    -0.040205241,	174.1407477,	-2.303760325,	151,	65,	134,	59,
    -0.080742944,	173.5655496,	-4.626570709,	144,	64,	127,	58,
    -0.137056079,	175.647374,	-7.853313302,	133,	62,	117,	56,
    0,	175,	0,	159,	66,	142,	60,
    -0.045419934,	176.1817244,	-2.602562202,	151,	65,	134,	59,
    0,	180,	0,	158,	66,	141,	60,
    0.051674278,	174.2326031,	2.960936134,	168,	68,	151,	62,
    0.113142647,	177.1327186,	6.483073693,	180,	70,	164,	64,
    0.049137115,	183.2211778,	2.815556684,	168,	68,	151,	62,
    0.064769351,	185.3887807,	3.711283808,	171,	68,	155,	62,
    0.160750899,	187.4166481,	9.211026541,	189,	71,	172,	65,
    -0.049954716,	180.2248596,	-2.862405226,	150,	65,	133,	59,
    -0.080465084,	186.6038585,	-4.610649319,	143,	64,	127,	57,
    -0.031901715,	188.0957203,	-1.827968244,	153,	65,	136,	59,
    0,	190,	0,	159,	66,	143,	59,
    0.040583847,	197.1623696,	2.325454421,	167,	67,	150,	60,
    0.028561554,	210.0856968,	1.636577042,	164,	66,	148,	60,
    0,	230,	0,	160,	64,	144,	58,
    -0.03075726,	260.1230478,	-1.762391024,	152,	63,	138,	57,
    0.037910066,	290.2085457,	2.172246805,	151,	63,	137,	56,
    0.034348214,	291.1717706,	1.968152643,	165,	65,	151,	59,
    0,	300,	0,	158,	63,	145,	57,
    -0.032639059,	245.1305774,	-1.870218096,	153,	63,	138,	57,
    -0.045048145,	244.247825,	-2.581258697,	150,	63,	136,	57,
    0.052976774,	264.3709515,	3.035569125,	168,	66,	154,	60,
    -0.038001707,	263.1900454,	-2.177497793,	151,	63,	137,	57


};

void find_Reference_Val_in_Table(float xl, float xr, float *angle, float *distance) {

    int i, min_seq;
    float d_dst_min = 1e6;

    for (i = 0; i < 220; i++) {

        float dx = xl - ref_table[i][3];
        float dy = xr - ref_table[i][5];
        float sq_err = sqrt(dx * dx + dy * dy);

        if (sq_err == 0) {
            min_seq = i;
            break;
        }
        else if (sq_err < d_dst_min) {
            // 查找最小误差的对应点集
            min_seq = i;
            d_dst_min = sq_err;
        }
    }

    *angle = ref_table[min_seq][2];
    *distance = ref_table[min_seq][1];

    cout << "distance_ref:" << *distance << endl;
}
